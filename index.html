<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Сибирская Лепка</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://fonts.googleapis.com/css?family=PT+Sans+Narrow:700&display=swap" rel="stylesheet">
  <style>
    body {
      background: #f5e9d7;
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      margin:0;
      min-height:100vh;
    }
    .header {
      text-align:center;
      padding:32px 0 10px 0;
      background: linear-gradient(90deg, #b22222 0%, #d32f2f 100%);
      box-shadow:0 2px 8px #0001;
      position:relative;
    }
    .logo-wrap {
      display:flex;
      align-items:center;
      justify-content:center;
      margin-bottom:10px;
      gap:18px;
    }
    .logo-img {
      width:70px; height:70px; border-radius:50%; box-shadow:0 2px 12px #0003; background:#fff;
      border:4px solid #fff; object-fit:cover;
      animation:logoPop .8s cubic-bezier(.5,1.8,.5,1) both;
    }
    @keyframes logoPop { from{transform:scale(0.7); opacity:0;} to{transform:scale(1); opacity:1;} }
    .header-title {
      font-size:2.6em;
      color:#fff;
      font-weight:bold;
      letter-spacing:4px;
      text-shadow:0 2px 12px #b22222, 0 0 2px #fff;
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      margin-bottom:0;
    }
    .header-desc {
      color:#ffe082;
      font-size:1.25em;
      font-weight:bold;
      letter-spacing:3px;
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      text-shadow:0 1px 4px #b22222;
      margin-top:4px;
    }
    .soviet-banner {
      text-align:center;
      margin-top:10px;
      margin-bottom:10px;
      letter-spacing:2px;
    }
    .soviet-banner-star {
      color:#b22222;
      font-size:2em;
      font-weight:bold;
      vertical-align:middle;
      text-shadow:0 1px 4px #fff;
    }
    .soviet-banner-text {
      color:#b22222;
      font-size:1.1em;
      font-family:'PT Sans Narrow',Arial,sans-serif;
      font-weight:bold;
      letter-spacing:2px;
      vertical-align:middle;
      margin:0 8px;
      text-shadow:0 1px 4px #fff;
    }
    .menu {
      display:flex; flex-wrap:wrap; gap:22px; justify-content:center; margin:30px 0 0 0;
    }
    .product {
      background: #fffbe6;
      border-radius:18px;
      box-shadow:0 2px 12px #b2222240;
      width:200px;
      padding:20px 14px 16px 14px;
      display:flex; flex-direction:column; align-items:center;
      transition:transform .2s,box-shadow .2s;
      position:relative;
      border:2px solid #b22222;
      font-family: 'PT Sans Narrow', Arial, sans-serif;
    }
    .product:not(.unavailable):hover {
      transform:translateY(-6px) scale(1.03);
      box-shadow:0 8px 24px #b2222240;
      border-color:#d32f2f;
    }
    .product.unavailable { opacity:.5; pointer-events:none; }
    .product-img {
      width:100px; height:100px; object-fit:cover; border-radius:12px; margin-bottom:10px; background:#eee;
      border:2px solid #b22222;
    }
    .product-name {
      font-size:1.2em; font-weight:bold; color:#b22222; margin-bottom:4px; text-align:center;
      letter-spacing:2px; text-transform:uppercase;
    }
    .product-desc {
      color:#7c6a5c; font-size:1em; margin-bottom:6px; text-align:center; min-height:32px;
    }
    .product-price {
      font-size:1.1em; color:#222; margin-bottom:10px; font-weight:bold; letter-spacing:1px;
    }
    .add-btn, .remove-btn {
      border:none; border-radius:6px; font-size:1.1em; padding:4px 12px; margin:0 4px; cursor:pointer; transition:background .2s;
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      font-weight:bold;
    }
    .add-btn { background:#b22222; color:#fff; }
    .remove-btn { background:#bcae99; color:#b22222; }
    .cart-fab {
      position:fixed; bottom:32px; right:32px; background:none; border:none; box-shadow:none;
      width:80px; height:80px; display:flex; align-items:center; justify-content:center;
      cursor:pointer; z-index:100; animation:popin .5s;
      padding:0;
      transition:transform .2s;
    }
    .cart-fab svg { display:block; filter: drop-shadow(0 2px 8px #b2222240);}
    .cart-fab-count {
      position:absolute; right:10px; top:10px; background:#fff; color:#b22222; font-weight:bold;
      border-radius:50%; min-width:28px; height:28px; display:flex; align-items:center; justify-content:center;
      font-size:1.2em; box-shadow:0 2px 8px #b2222240; border:2px solid #b22222;
      pointer-events:none;
    }
    .cart-modal-bg {
      position:fixed; left:0; top:0; width:100vw; height:100vh; background:#b2222280; z-index:200;
      display:flex; align-items:flex-start; justify-content:center; animation:fadein .3s;
    }
    @keyframes fadein { from{opacity:0;} to{opacity:1;} }
    .cart-modal {
      background:#fffbe6; border-radius:24px; padding:28px 20px 20px 20px; min-width:340px; max-width:95vw;
      box-shadow:0 8px 32px #b2222240; position:relative;
      border:2px solid #b22222;
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      max-height:90vh; overflow-y:auto;
      display:flex; flex-direction:column;
      margin-top:40px;
    }
    .cart-title { font-size:1.3em; color:#b22222; margin-bottom:10px; letter-spacing:2px; }
    .cart-list { list-style:none; padding:0; margin:0 0 10px 0; }
    .cart-list li { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
    .cart-total { font-size:1.1em; color:#222; margin-bottom:12px; text-align:right; font-weight:bold; }
    .cart-close { position:absolute; right:14px; top:10px; font-size:1.5em; color:#b22222; background:none; border:none; cursor:pointer; }
    .order-form input, .order-form textarea, .order-form select {
      width:100%; padding:8px; margin-bottom:8px; border-radius:6px; border:1px solid #bcae99; font-size:1em;
      background:#fff; font-family: 'PT Sans Narrow', Arial, sans-serif;
    }
    .order-btn {
      background:#b22222; color:#fff; border:none; border-radius:8px; padding:10px 18px; font-size:1.1em; font-weight:bold; cursor:pointer; width:100%; margin-top:8px;
      font-family: 'PT Sans Narrow', Arial, sans-serif;
      letter-spacing:2px;
    }
    .order-success { color:#388e3c; font-size:1.2em; text-align:center; margin-top:10px; }
    .unavailable-label {
      position:absolute; left:0; top:0; right:0; background:#bcae99; color:#fff; font-size:.95em; border-radius:18px 18px 0 0; padding:2px 0; text-align:center; letter-spacing:1px;
    }
    @media (max-width:600px) {
      .menu { gap:8px; }
      .product { width:44vw; min-width:120px; padding:10px 4px 10px 4px; }
      .product-img { width:60px; height:60px; }
      .cart-modal { min-width:90vw; padding:12px 4px 10px 4px; border-radius:20px; margin-top:12vw;}
      .cart-fab { width:56px; height:56px; bottom:12px; right:10px; top:auto !important;}
      .cart-fab-count { min-width:18px; height:18px; font-size:.9em; right:2px; top:2px; }
      .logo-img { width:48px; height:48px; }
      .header-title { font-size:1.5em; }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo-wrap">
      <img class="logo-img" src="https://i.postimg.cc/Hnh3y4jd/Chat-GPT-Image-23-2025-15-50-54.png" alt="Логотип">
      <div>
        <div class="header-title">СИБИРСКАЯ ЛЕПКА</div>
        <div class="header-desc">
          100% РУЧНАЯ ЛЕПКА. ПО ГОСТу
        </div>
      </div>
    </div>
    <div class="soviet-banner">
      <span class="soviet-banner-star">★</span>
      <span class="soviet-banner-text">КАЧЕСТВО ПРОВЕРЕНО ВРЕМЕНЕМ</span>
      <span class="soviet-banner-star">★</span>
    </div>
  </div>
  <div class="menu" id="menu"></div>
  <button id="cartFab" class="cart-fab" style="display:none;" title="Корзина">
    <svg viewBox="0 0 48 48" width="56" height="56" style="display:block;margin:auto;">
      <circle cx="24" cy="24" r="22" fill="#b22222" stroke="#fff" stroke-width="2"/>
      <path d="M16 18h16l-2 13a3 3 0 0 1-3 2h-6a3 3 0 0 1-3-2l-2-13zm3 0v-4a3 3 0 0 1 3-3h2a3 3 0 0 1 3 3v4" fill="none" stroke="#fff" stroke-width="2.5" stroke-linecap="round"/>
      <circle cx="19" cy="36" r="2" fill="#fff"/>
      <circle cx="29" cy="36" r="2" fill="#fff"/>
    </svg>
    <span id="cartFabCount" class="cart-fab-count"></span>
  </button>
  <div id="cartModalBg" style="display:none;"></div>
  <script>
    // --- Настройки ---
    const SHEET_API_URL = 'https://script.google.com/macros/s/AKfycbxu0lkODTN7jGBCqYbsNA0-njTGFfzqQ878N4iDW2w-VW6-fScQf0ku2PAtxxq_c3lN/exec';
    const TELEGRAM_BOT_TOKEN = '7253551384:AAGg18hGzmFAL1tVGIbqapy43wFtA0xwivc';
    const TELEGRAM_CHAT_ID = '7567253745';

    let menuData = [];
    let cart = {};

    // --- Загрузка меню ---
    async function loadMenu() {
      try {
        const res = await fetch(SHEET_API_URL);
        let data = await res.json();
        if (data.menu) data = data.menu;
        menuData = data.map((item, idx) => ({
          ...item,
          price: Number(item.price),
          available: String(item.available).trim().toLowerCase() === "true",
          id: idx + 1
        }));
        renderMenu();
      } catch (e) {
        document.getElementById('menu').innerHTML = '<div style="color:#b22222;font-size:1.2em;text-align:center;margin:40px auto;">Ошибка загрузки меню. Проверьте подключение или API Google Sheets.</div>';
      }
    }

    // --- Рендер меню ---
    function renderMenu() {
      const menu = document.getElementById('menu');
      menu.innerHTML = '';
      menuData.forEach(item => {
        const prod = document.createElement('div');
        prod.className = 'product' + (!item.available ? ' unavailable' : '');
        prod.innerHTML = `
          ${!item.available ? `<div class="unavailable-label">Нет в наличии</div>` : ''}
          <img class="product-img" src="${item.img}" alt="${item.name}">
          <div class="product-name">${item.name}</div>
          <div class="product-desc">${item.description || ''}</div>
          <div class="product-price">${item.price.toLocaleString('ru-RU')} VND</div>
          <div>
            <button class="remove-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},-1)">-</button>
            <span id="qty-${item.id}">${cart[item.id]?.qty||0}</span>
            <button class="add-btn" ${!item.available ? 'disabled' : ''} onclick="updateCart(${item.id},1)">+</button>
          </div>
        `;
        menu.appendChild(prod);
      });
      updateCartFab();
    }

    // --- Корзина ---
    window.updateCart = function(id, delta) {
      const item = menuData.find(i=>i.id===id);
      if (!item || !item.available) return;
      if (!cart[id]) cart[id] = { ...item, qty: 0 };
      cart[id].qty = Math.max(0, cart[id].qty + delta);
      if (cart[id].qty === 0) delete cart[id];
      document.getElementById(`qty-${id}`).textContent = cart[id]?.qty || 0;
      updateCartFab();
      if (document.getElementById('cartModalBg').style.display === 'flex') showCartModal();
    };

    function updateCartFab() {
      const fab = document.getElementById('cartFab');
      const count = Object.values(cart).reduce((s,i)=>s+i.qty,0);
      fab.style.display = 'flex';
      document.getElementById('cartFabCount').textContent = count>0 ? count : '';
    }

    document.getElementById('cartFab').onclick = showCartModal;

    function showCartModal() {
      const modalBg = document.getElementById('cartModalBg');
      modalBg.innerHTML = `
        <div class="cart-modal">
          <button class="cart-close" onclick="closeCartModal()">&times;</button>
          <div class="cart-title">Корзина</div>
          <ul class="cart-list">
            ${Object.values(cart).length === 0 ? '<li style="color:#b22222;text-align:center;width:100%;">Корзина пуста</li>' : Object.values(cart).map(item=>`
              <li>
                <span>${item.name} x${item.qty}</span>
                <span>
                  <button class="remove-btn" onclick="updateCart(${item.id},-1)">-</button>
                  <span>${(item.price*item.qty).toLocaleString('ru-RU')} VND</span>
                  <button class="add-btn" onclick="updateCart(${item.id},1)">+</button>
                </span>
              </li>
            `).join('')}
          </ul>
          <div class="cart-total">Итого: ${Object.values(cart).reduce((s,i)=>s+i.price*i.qty,0).toLocaleString('ru-RU')} VND</div>
          <form class="order-form" id="orderForm">
            <input type="text" id="name" placeholder="Имя или ник в Telegram" required>
            <input type="tel" id="phone" placeholder="Телефон" required>
            <div style="display:flex;gap:8px;align-items:center;">
              <input type="text" id="address" placeholder="Адрес доставки" required style="flex:1;">
              <button type="button" id="showMapBtn" style="padding:8px 10px;font-size:1.1em;border-radius:6px;border:1px solid #bcae99;background:#fff;cursor:pointer;" title="Указать на карте">📍</button>
            </div>
            <div id="mapContainer" style="display:none;margin:10px 0;">
              <iframe id="gmapFrame" width="100%" height="220" style="border:1px solid #bcae99;border-radius:8px;" allowfullscreen="" loading="lazy" referrerpolicy="no-referrer-when-downgrade"></iframe>
              <div style="font-size:.95em;color:#7c6a5c;margin-top:4px;">Выберите точку на карте, скопируйте адрес и вставьте в поле выше.</div>
            </div>
            <select id="payment">
              <option value="">Способ оплаты (необязательно)</option>
              <option value="cash">Наличные</option>
              <option value="card">Карта</option>
            </select>
            <textarea id="comment" placeholder="Комментарий к заказу (необязательно)" rows="2"></textarea>
            <button type="submit" class="order-btn">Оформить заказ</button>
            <div id="orderSuccess" class="order-success" style="display:none;"></div>
          </form>
        </div>
      `;
      modalBg.style.display = 'flex';
      document.getElementById('orderForm').onsubmit = sendOrder;

      // --- Карта Google Maps ---
      const showMapBtn = document.getElementById('showMapBtn');
      const mapContainer = document.getElementById('mapContainer');
      const gmapFrame = document.getElementById('gmapFrame');
      if (showMapBtn) {
        showMapBtn.onclick = function() {
          mapContainer.style.display = mapContainer.style.display === 'none' ? 'block' : 'none';
          if (mapContainer.style.display === 'block') {
            gmapFrame.src = "https://www.google.com/maps/embed?pb=!1m18!1m12!1m3!1d1998.617839964971!2d82.9204303161167!3d55.03019998037237!2m3!1f0!2f0!3f0!3m2!1i1024!2i768!4f13.1!3m3!1m2!1s0x42d4e4c2d7e6e6b1%3A0x2b2b2b2b2b2b2b2b!2z0J3QsNC30LDRgNCw0LvRjNC90YvQuSDQv9C-0YHRgtCw0L3QuNC5INC60L7QvNC_0L7QstCw0YAg0JrQvtC80L7QstCw0YAg0JzQvtGB0YLQsNC30LjQvdCw!5e0!3m2!1sru!2sru!4v1680000000000!5m2!1sru!2sru";
          }
        };
      }

      setTimeout(() => {
        const modal = document.querySelector('.cart-modal');
        if (modal) modal.scrollIntoView({behavior: "smooth", block: "start"});
      }, 50);
    }
    window.closeCartModal = function() {
      document.getElementById('cartModalBg').style.display = 'none';
    };

    // --- Отправка заказа ---
    async function sendOrder(e) {
      e.preventDefault();
      const btn = document.querySelector('.order-btn');
      btn.disabled = true;
      btn.textContent = 'Отправка...';
      const name = document.getElementById('name').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const address = document.getElementById('address').value.trim();
      const payment = document.getElementById('payment').value;
      const comment = document.getElementById('comment').value.trim();
      if (!name || !phone || !address) {
        alert('Пожалуйста, заполните все обязательные поля!');
        btn.disabled = false; btn.textContent = 'Оформить заказ'; return;
      }
      const itemsArr = Object.values(cart);
      const total = itemsArr.reduce((s,i)=>s+i.price*i.qty,0);
      let orderLines = itemsArr.map(i=>`${i.name} x${i.qty} — ${(i.price*i.qty).toLocaleString('ru-RU')} VND`).join('\n');
      let paymentText = payment==='cash'?'Оплата: Наличные':payment==='card'?'Оплата: Карта':'';
      const text =
        `🛒 Новый заказ!\n` +
        `Имя/ник: ${name}\nТелефон: ${phone}\nАдрес: ${address}\n` +
        (paymentText?paymentText+'\n':'') +
        (comment?`Комментарий: ${comment}\n`:'') +
        `\nЗаказ:\n${orderLines}\n\nСумма: ${total.toLocaleString('ru-RU')} VND`;
      try {
        const response = await fetch(`https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage`, {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text })
        });
        const result = await response.json();
        if (result.ok) {
          btn.style.display = 'none';
          document.getElementById('orderSuccess').style.display = 'block';
          document.getElementById('orderSuccess').textContent = 'Спасибо! Ваша заявка принята.';
          cart = {};
          setTimeout(()=>{ closeCartModal(); renderMenu(); }, 2000);
        } else {
          alert('Ошибка отправки заказа. Попробуйте позже.');
          btn.disabled = false; btn.textContent = 'Оформить заказ';
        }
      } catch {
        alert('Ошибка отправки заказа. Попробуйте позже.');
        btn.disabled = false; btn.textContent = 'Оформить заказ';
      }
    }

    // --- Инициализация ---
    loadMenu();
      </script>
</body>
</html>
